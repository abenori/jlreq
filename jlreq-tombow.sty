\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{jlreq-tombow}[2018/04/12 jlreq-tombow]
\RequirePackage{xkeyval,ifthen}
\RequirePackage{jlreq-helpers}

\newcommand*{\jlreq@tombow@undeferr}[1]{\PackageError{jlreq-tombow}{Trying to delete \string#1 even though it is not defined, may be a bug}{\@ehc}}
% クラスファイル内でしか使わないマクロをクラスファイル終了時に未定義にする
\newcommand*{\jlreq@tombow@afterpkg@addtodeletecs}[1]{%
  \appto\jlreq@tombow@afterpkg@deletecslist{\jlreq@helper@undefcs{#1}{\jlreq@tombow@undeferr}}%
}
\newcommand*{\jlreq@tombow@afterpkg@addtodeleteif}[1]{%
  \appto\jlreq@tombow@afterpkg@deletecslist{\jlreq@helper@undefif{#1}{\jlreq@tombow@undeferr}}%
}
\jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@afterpkg@addtodeletecs}
\jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@afterpkg@addtodeleteif}
\AtEndOfPackage{%
  \jlreq@tombow@afterpkg@deletecslist
  \jlreq@helper@undefcs{\jlreq@tombow@afterpkg@deletecslist}{\jlreq@tombow@undeferr}%
  \undef{\jlreq@tombow@undeferr}%
}

\newcommand*{\jlreq@tombow@DeclareOption}[2]{%
  \DeclareOptionX{#1}{%
    \jlreq@ifempty{##1}{}{\PackageError{jlreq-tombow}{The option #1 should have no value}{\@ehc}}%
    #2%
  }
}
\jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@DeclareOption}

\@ifclassloaded{jlreq}{\let\ifjlreq@tombow@jlreqloaded=\@firstoftwo}{\let\ifjlreq@tombow@jlreqloaded=\@secondoftwo}

% \jlreq@tombow@driver：ドライバ
% dvipdfmx=f，dvips=s，luatex=l
\jlreq@tombow@DeclareOption{dvipdfmx}{\let\jlreq@tombow@driver=f}
\jlreq@tombow@DeclareOption{dvips}{\let\jlreq@tombow@driver=s}
\let\jlreq@tombow@engine=\jlreq@engine
\jlreq@tombow@DeclareOption{lualatex}{\let\jlreq@tombow@engine=l}
\jlreq@tombow@DeclareOption{uplatex}{\let\jlreq@tombow@engine=u}
\jlreq@tombow@DeclareOption{platex}{\let\jlreq@tombow@engine=p}

% 必要サイズ
% (1) トンボ付きのひとまわり大きな紙面のサイズ=MediaBox/CropBox：\paperwidth/\paperheight
% (2) 仕上がり紙面サイズ=TrimBox/ArtBox：\jlreq@tombow@paperwidth/\jlreq@tombow@paperheight
% (3) 裁ち落とし領域を含んだサイズ=BleedBox：(2)からの差を\jlreq@tombow@bleemに入れる
\def\jlreq@tombow@switchpapersize{}
\def\jlreq@tombow@addpapersize#1#2{%
  \@ifnextchar[{\jlreq@tombow@addpapersize@{#1}{#2}}{\jlreq@tombow@addpapersize@@{#1}{#2}}
}
\def\jlreq@tombow@addpapersize@#1#2[#3]{%
  \edef\@tempa{\unexpanded{\jlreq@tombow@addpapersize@@{#1}{#2}}\csexpandonce{jlreq@helper@papersizelist@#3}}%
  \@tempa
}
\newcommand*{\jlreq@tombow@addpapersize@@}[4]{%
  \@for\@tempa:=#1\do{%
    \eappto\jlreq@tombow@switchpapersize{{\expandonce{\@tempa}}{\unexpanded{\def\jlreq@tombow@paperwidth{#3}\def\jlreq@tombow@paperheight{#4}}}}%
  }%
  \@for\@tempa:=#2\do{%
    \expandafter\jlreq@tombow@DeclareOption\expandafter{\@tempa}{\def\jlreq@tombow@paperwidth{#3}\def\jlreq@tombow@paperheight{#4}}%
  }%
}
\jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@switchpapersize}
\jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@addpapersize}
\jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@addpapersize@}
\jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@addpapersize@@}

\jlreq@tombow@addpapersize{a0,A0}{}[a0]
\jlreq@tombow@addpapersize{a1,A1}{}[a1]
\jlreq@tombow@addpapersize{a2,A2}{}[a2]
\jlreq@tombow@addpapersize{a3,A3}{a3paper}[a3]
\jlreq@tombow@addpapersize{a4,A4}{a4paper}[a4]
\jlreq@tombow@addpapersize{a5,A5}{a5paper}[a5]
\jlreq@tombow@addpapersize{a6,A6}{a6paper}[a6]
\jlreq@tombow@addpapersize{a7,A7}{}[a7]
\jlreq@tombow@addpapersize{a8,A8}{}[a8]
\jlreq@tombow@addpapersize{a9,A9}{}[a9]
\jlreq@tombow@addpapersize{a10,A10}{}[a10]

\jlreq@tombow@addpapersize{b0,B0}{}[b0]
\jlreq@tombow@addpapersize{b1,B1}{}[b1]
\jlreq@tombow@addpapersize{b2,B2}{}[b2]
\jlreq@tombow@addpapersize{b3,B3}{}[b3]
\jlreq@tombow@addpapersize{b4,B4}{b4paper}[b4]
\jlreq@tombow@addpapersize{b5,B5}{b5paper}[b5]
\jlreq@tombow@addpapersize{b6,B6}{b6paper}[b6]
\jlreq@tombow@addpapersize{b7,B7}{}[b7]
\jlreq@tombow@addpapersize{b8,B8}{}[b8]
\jlreq@tombow@addpapersize{b9,B9}{}[b9]
\jlreq@tombow@addpapersize{b10,B10}{}[b10]

\jlreq@tombow@addpapersize{c2,C2}{}[c2]
\jlreq@tombow@addpapersize{c3,C3}{}[c3]
\jlreq@tombow@addpapersize{c4,C4}{}[c4]
\jlreq@tombow@addpapersize{c5,C5}{}[c5]
\jlreq@tombow@addpapersize{c6,C6}{}[c6]
\jlreq@tombow@addpapersize{c7,C7}{}[c7]
\jlreq@tombow@addpapersize{c8,C8}{}[c8]

\jlreq@tombow@addpapersize{a4var}{}[a4var]
\jlreq@tombow@addpapersize{b5var}{}[b5var]

\jlreq@tombow@addpapersize{letter}{letterpaper}[letter]
\jlreq@tombow@addpapersize{legal}{legalpaper}[legal]
\jlreq@tombow@addpapersize{executive}{executivepaper}[executive]
\jlreq@tombow@addpapersize{hagaki}{}[hagaki]

\DeclareOptionX{tombow_paper}{
  \edef\jlreq@do{%
    \unexpanded{\jlreq@switch{#1}}{\expandonce{\jlreq@tombow@switchpapersize}}%
    [\unexpanded{%
      \jlreq@helper@dividebycomma{#1}%
      \ifjlreq@result
        \edef\jlreq@tombow@paperwidth{\jlreq@resulta}
        \edef\jlreq@tombow@paperheight{\jlreq@resultb}
      \else
        \PackageError{jlreq}{The paper #1 is unknown}{\@ehc}%
      \fi
    }]%
  }%
  \jlreq@do
}
\def\jlreq@tombow@bleed{3mm}
\DeclareOptionX{bleed_margin}{\def\jlreq@tombow@bleed{#1}}

\newif\ifjlreq@tombow@digital \jlreq@tombow@digitaltrue
\newif\ifjlreq@tombow@show \jlreq@tombow@showtrue
\DeclareOptionX{show}{%
  \jlreq@tombow@showfalse\tombowdatefalse\jlreq@tombow@digitalfalse
  \@for\jlreq@tombow@tempa:=#1\do{%
    \jlreq@switch{\jlreq@tombow@tempa}{
      {tombow}{\jlreq@tombow@showtrue}
      {date}{\tombowdatetrue}
      {digital}{\jlreq@tombow@digitaltrue}
    }[\PackageError{jlreq-tombow}{Unknown value `##1' in the option `show'}{@ehc}]
  }
}
\DeclareOptionX{tombow_width}{\setlength{\@tombowwidth}{#1}}

% 色
\def\jlreq@tombow@color{}
\DeclareOptionX{tombow_color}{\def\jlreq@tombow@color{#1}}

\let\jlreq@temporary@original@@removeelement=\@removeelement
\let\@removeelement=\jlreq@helper@removeelement
\ProcessOptionsX*\relax
\let\@removeelement=\jlreq@temporary@original@@removeelement
\let\jlreq@temporary@original@@removeelement=\@undefined

\newcommand{\jlreqtombowsetup}[1]{%
  \jlreq@parsekeyval{%
    {banner}{\@bannertoken{##1}\maketombowbox}
  }{#1}
}
\@onlypreamble\jlreqtombowsetup
\jlreqtombowsetup{
  banner={
    \jobname\space(\number\year-\two@digits\month-\two@digits\day
    \space\two@digits\hour:\two@digits\minute)%
  }
}

\ifx\jlreq@tombow@engine\@undefined
  \jlreq@helper@guessengine
  \let\jlreq@tombow@engine=\jlreq@result
\fi

\ifx\jlreq@tombow@driver\@undefined
  \ifx l\jlreq@tombow@engine
    \let\jlreq@tombow@driver=l
  \else
    % platex/uplatexの時はドライバのデフォルトはdvipdfmx
    \let\jlreq@tombow@driver=f
  \fi
\fi

% 色
\ifx\jlreq@tombow@color\@empty\else
  \@ifpackageloaded{xcolor}{}{\PackageError{jlreq-tombow}{The package `xcolor' must be loaded before this package to use `tombow_color' option}{\@ehc}}
  \def\jlreq@tombow@parsecolor@woption[#1]#2\jlreq@endmark{%
    \def\jlreq@tombow@color{\color[#1]{#2}}%
  }
  \def\jlreq@tombow@parsecolor@wooption#1\jlreq@endmark{%
    \def\jlreq@tombow@color{\color{#1}}%
  }
  \jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@parsecolor@woption}
  \jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@parsecolor@wooption}
  \jlreq@switch{\jlreq@tombow@color}{
    {c}{\def\jlreq@tombow@color{\color[cmyk]{1,0,0,0}}}
    {m}{\def\jlreq@tombow@color{\color[cmyk]{0,1,0,0}}}
    {y}{\def\jlreq@tombow@color{\color[cmyk]{0,0,1,0}}}
    {k}{\def\jlreq@tombow@color{\color[cmyk]{0,0,0,1}}}
    {cm}{\def\jlreq@tombow@color{\color[cmyk]{1,1,0,0}}}
    {cy}{\def\jlreq@tombow@color{\color[cmyk]{1,0,1,0}}}
    {ck}{\def\jlreq@tombow@color{\color[cmyk]{1,0,0,1}}}
    {my}{\def\jlreq@tombow@color{\color[cmyk]{0,1,1,0}}}
    {mk}{\def\jlreq@tombow@color{\color[cmyk]{0,1,0,1}}}
    {yk}{\def\jlreq@tombow@color{\color[cmyk]{0,0,1,1}}}
    {cmy}{\def\jlreq@tombow@color{\color[cmyk]{1,1,1,0}}}
    {cmk}{\def\jlreq@tombow@color{\color[cmyk]{1,1,0,1}}}
    {cyk}{\def\jlreq@tombow@color{\color[cmyk]{1,0,1,1}}}
    {myk}{\def\jlreq@tombow@color{\color[cmyk]{0,1,1,1}}}
    {cmyk}{\def\jlreq@tombow@color{\color[cmyk]{0,1,1,1}}}
  }[{
    \expandafter\jlreq@iffirsttoken\expandafter{\jlreq@tombow@color}{[}{%
      \expandafter\jlreq@tombow@parsecolor@woption\jlreq@tombow@color\jlreq@endmark
    }{
      \expandafter\jlreq@tombow@parsecolor@wooption\jlreq@tombow@color\jlreq@endmark
    }
  }]
\fi

% 紙サイズ
\ifx\jlreq@tombow@paperwidth\@undefined % 紙サイズが指定されなかった
  \edef\jlreq@tombow@paperwidth{\the\dimexpr\paperwidth + 2in\relax}
  \edef\jlreq@tombow@paperheight{\the\dimexpr\paperheight + 2in\relax}
\fi

\ifx l\jlreq@engine
  \setlength{\pagewidth}{\jlreq@tombow@paperwidth}
  \setlength{\pageheight}{\jlreq@tombow@paperheight}
\else
  \setlength{\pdfpagewidth}{\jlreq@tombow@paperwidth}
  \setlength{\pdfpageheight}{\jlreq@tombow@paperheight}
\fi

% ずらす……
\hoffset=\dimexpr(\jlreq@tombow@paperwidth - \paperwidth)/2 - 1in\relax
\voffset=\dimexpr(\jlreq@tombow@paperheight - \paperheight)/2 - 1in\relax

\ifx l\jlreq@tombow@driver\else
  \AtBeginDvi{\special{papersize=\jlreq@tombow@paperwidth,\jlreq@tombow@paperheight}}
\fi
% graphicx対策
\@ifundefined{stockwidth}{\newdimen\stockwidth}{}
\@ifundefined{stockheight}{\newdimen\stockheight}{}
\setlength{\stockwidth}{\jlreq@tombow@paperwidth}
\setlength{\stockheight}{\jlreq@tombow@paperheight}

\def\maketombowbox{%
  \setbox\@TL\hbox to\z@{\yoko\hss
      \vrule width\dimexpr 10mm + \jlreq@tombow@bleed\relax height\@tombowwidth depth\z@
      \vrule height10mm width\@tombowwidth depth\z@
      \iftombowdate
        \raise4pt\hbox to\z@{\hskip5mm\@bannerfont\the\@bannertoken\hss}%
      \fi}%
  \setbox\@Tl\hbox to\z@{\yoko\hss
      \vrule width10mm height\@tombowwidth depth\z@
      \vrule height\dimexpr 10mm + \jlreq@tombow@bleed\relax width\@tombowwidth depth\z@}%
  \setbox\@TC\hbox{\yoko
      \vrule width10mm height\@tombowwidth depth\z@
      \vrule height10mm width\@tombowwidth depth\z@
      \vrule width10mm height\@tombowwidth depth\z@}%
  \setbox\@TR\hbox to\z@{\yoko
      \vrule height10mm width\@tombowwidth depth\z@
      \vrule width\dimexpr 10mm + \jlreq@tombow@bleed\relax height\@tombowwidth depth\z@\hss}%
  \setbox\@Tr\hbox to\z@{\yoko
      \vrule height\dimexpr 10mm + \jlreq@tombow@bleed\relax width\@tombowwidth depth\z@
      \vrule width10mm height\@tombowwidth depth\z@\hss}%
  \setbox\@BL\hbox to\z@{\yoko\hss
      \vrule width\dimexpr 10mm + \jlreq@tombow@bleed\relax depth\@tombowwidth height\z@
      \vrule depth10mm width\@tombowwidth height\z@}%
  \setbox\@Bl\hbox to\z@{\yoko\hss
      \vrule width10mm depth\@tombowwidth height\z@
      \vrule depth\dimexpr 10mm + \jlreq@tombow@bleed\relax width\@tombowwidth height\z@}%
  \setbox\@BC\hbox{\yoko
      \vrule width10mm depth\@tombowwidth height\z@
      \vrule depth10mm width\@tombowwidth height\z@
      \vrule width10mm depth\@tombowwidth height\z@}%
  \setbox\@BR\hbox to\z@{\yoko
      \vrule depth10mm width\@tombowwidth height\z@
      \vrule width\dimexpr 10mm + \jlreq@tombow@bleed\relax depth\@tombowwidth height\z@\hss}%
  \setbox\@Br\hbox to\z@{\yoko
      \vrule depth\dimexpr 10mm + \jlreq@tombow@bleed\relax width\@tombowwidth height\z@
      \vrule width10mm depth\@tombowwidth height\z@\hss}%
  \setbox\@CL\hbox to\z@{\yoko\hss
      \vrule width10mm height.5\@tombowwidth depth.5\@tombowwidth
      \vrule height10mm depth10mm width\@tombowwidth}%
  \setbox\@CR\hbox to\z@{\yoko
      \vrule height10mm depth10mm width\@tombowwidth
      \vrule height.5\@tombowwidth depth.5\@tombowwidth width10mm\hss}%
}
\def\@outputtombow{%
  % 6mmはplatex etcのカーネル由来
  \@@paperwidth=\dimexpr\@@paperwidth - 6mm + 2\dimexpr\jlreq@tombow@bleed\relax\relax
  \@@paperheight=\dimexpr\@@paperheight - 6mm + 2\dimexpr\jlreq@tombow@bleed\relax\relax
  \ifjlreq@tombow@show
  \vbox to\z@{\kern-\dimexpr 10mm + \jlreq@tombow@bleed\relax\relax
    \boxmaxdepth\maxdimen
    \moveleft\jlreq@tombow@bleed\vbox to\@@paperheight{%
      \color@begingroup\jlreq@tombow@color
      \hbox to\@@paperwidth{\hskip\jlreq@tombow@bleed\relax
         \copy\@TL\hfill\copy\@TC\hfill\copy\@TR\hskip\jlreq@tombow@bleed}%
      \kern-10mm
      \hbox to\@@paperwidth{\copy\@Tl\hfill\copy\@Tr}%
      \vfill
      \hbox to\@@paperwidth{\copy\@CL\hfill\copy\@CR}%
      \vfill
      \hbox to\@@paperwidth{\copy\@Bl\hfill\copy\@Br}%
      \kern-10mm
      \hbox to\@@paperwidth{\hskip\jlreq@tombow@bleed\relax
         \copy\@BL\hfill\copy\@BC\hfill\copy\@BR\hskip\jlreq@tombow@bleed}%
    \color@endgroup}\vss
  }%
  \fi
}

\ifjlreq@tombow@digital
  \def\jlreq@tombow@pttobp#1{\strip@pt\dimexpr0.9963\dimexpr#1\relax\relax}
  \edef\jlreq@tombow@trimboxsize{
    [
      \jlreq@tombow@pttobp{(\jlreq@tombow@paperwidth - \paperwidth)/2}
      \jlreq@tombow@pttobp{(\jlreq@tombow@paperheight - \paperheight)/2}
      \jlreq@tombow@pttobp{(\jlreq@tombow@paperwidth + \paperwidth)/2}
      \jlreq@tombow@pttobp{(\jlreq@tombow@paperheight + \paperheight)/2}
    ]
  }
  \edef\jlreq@tombow@bleedboxsize{
    [
      \jlreq@tombow@pttobp{(\jlreq@tombow@paperwidth - \paperwidth)/2 - \jlreq@tombow@bleed}
      \jlreq@tombow@pttobp{(\jlreq@tombow@paperheight - \paperheight)/2 - \jlreq@tombow@bleed}
      \jlreq@tombow@pttobp{(\jlreq@tombow@paperwidth + \paperwidth)/2 + \jlreq@tombow@bleed}
      \jlreq@tombow@pttobp{(\jlreq@tombow@paperheight + \paperheight)/2 + \jlreq@tombow@bleed}
    ]
  }
  \edef\jlreq@tombow@cropboxsize{
    [0 0 \jlreq@tombow@pttobp{\jlreq@tombow@paperwidth} \jlreq@tombow@pttobp{\jlreq@tombow@paperheight}]
  }
  \edef\jlreq@tombow@pdfattribute{%
    /CropBox \jlreq@tombow@cropboxsize\space
    /TrimBox \jlreq@tombow@trimboxsize\space
    /ArtBox \jlreq@tombow@trimboxsize\space
    /BleedBox \jlreq@tombow@bleedboxsize\space
  }
  \jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@pttobp}
  \jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@trimboxsize}
  \jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@cropboxsize}
  \jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@bleedboxsize}
  \jlreq@tombow@afterpkg@addtodeletecs{\jlreq@tombow@pdfattribute}

  \ifx l\jlreq@tombow@driver
    \edef\@tempa{\noexpand\pdfvariable pageattr{\jlreq@tombow@pdfattribute}}
    \@tempa
  \fi
  \ifx f\jlreq@tombow@driver
    \edef\@outputtombow{\noexpand\special{pdf: put @thispage <<\jlreq@tombow@pdfattribute>>}\expandonce{\@outputtombow}}
  \fi
  \ifx s\jlreq@tombow@driver
    \edef\@tempa{\noexpand\special{ps:SDict begin 
      [ /CropBox \jlreq@tombow@cropboxsize\space /PAGE pdfmark
      [ /TrimBox  \jlreq@tombow@trimboxsize\space /PAGE pdfmark
      [ /ArtBox   \jlreq@tombow@trimboxsize\space /PAGE pdfmark
      [ /BleedBox \jlreq@tombow@bleedboxsize\space /PAGE pdfmark
    end}}%
    \@tempa
  \fi
\fi

% トンボ処理自身は常にtrueにする．
\tombowtrue
\maketombowbox

\endinput
