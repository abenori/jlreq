\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{jlreq-trimmarks}[2018/09/01 jlreq-trimmarks]
\RequirePackage{xkeyval,etoolbox}
\RequirePackage{jlreq-helpers}

% check \tombowdatetrue
\ifx\tombowdatetrue\@undefined
  \PackageError{jlreq-trimmarks}{This package only works with pLaTeX, upLaTeX or LuaTeX-ja}{\@ehc}
\fi

\newcommand*{\jlreq@trimmarks@undeferr}[1]{\PackageError{jlreq-trimmarks}{Trying to delete \string#1 even though it is not defined, may be a bug}{\@ehc}}
\newcommand*{\jlreq@trimmarks@afterpkg@addtodeletecs}[1]{%
  \appto\jlreq@trimmarks@afterpkg@deletecslist{\jlreq@helper@undefcs{#1}{\jlreq@trimmarks@undeferr}}%
}
\newcommand*{\jlreq@trimmarks@afterpkg@addtodeleteif}[1]{%
  \appto\jlreq@trimmarks@afterpkg@deletecslist{\jlreq@helper@undefif{#1}{\jlreq@trimmarks@undeferr}}%
}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@afterpkg@addtodeletecs}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@afterpkg@addtodeleteif}
\AtEndOfPackage{%
  \jlreq@trimmarks@afterpkg@deletecslist
  \jlreq@helper@undefcs{\jlreq@trimmarks@afterpkg@deletecslist}{\jlreq@trimmarks@undeferr}%
  \undef{\jlreq@trimmarks@undeferr}%
}

\newcommand*{\jlreq@trimmarks@DeclareOption}[2]{%
  \DeclareOptionX{#1}{%
    \jlreq@ifempty{##1}{}{\PackageError{jlreq-trimmarks}{The option #1 should have no value}{\@ehc}}%
    #2%
  }
}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@DeclareOption}

\@ifclassloaded{jlreq}{\let\ifjlreq@trimmarks@jlreqloaded=\@firstoftwo}{\let\ifjlreq@trimmarks@jlreqloaded=\@secondoftwo}

% dvipdfmx=f，dvips=s，dviout = o, lualatex = l
\jlreq@trimmarks@DeclareOption{dvipdfmx}{\let\jlreq@trimmarks@driver=f}
\jlreq@trimmarks@DeclareOption{dvips}{\let\jlreq@trimmarks@driver=s}
\jlreq@trimmarks@DeclareOption{dviout}{\let\jlreq@trimmarks@driver=o}
\let\jlreq@trimmarks@engine=\jlreq@engine
\jlreq@trimmarks@DeclareOption{lualatex}{\let\jlreq@trimmarks@engine=l}
\jlreq@trimmarks@DeclareOption{uplatex}{\let\jlreq@trimmarks@engine=u}
\jlreq@trimmarks@DeclareOption{platex}{\let\jlreq@trimmarks@engine=p}

\def\jlreq@trimmarks@switchpapersize{}
\def\jlreq@trimmarks@addpapersize#1{%
  \@ifnextchar[{\jlreq@trimmarks@addpapersize@{#1}}{\jlreq@trimmarks@addpapersize@@{#1}}
}
\def\jlreq@trimmarks@addpapersize@#1[#2]{%
  \edef\@tempa{\unexpanded{\jlreq@trimmarks@addpapersize@@{#1}}\csexpandonce{jlreq@helper@papersizelist@#2}}%
  \@tempa
}
\newcommand*{\jlreq@trimmarks@addpapersize@@}[3]{%
  \@for\@tempa:=#1\do{%
    \eappto\jlreq@trimmarks@switchpapersize{{\expandonce{\@tempa}}{\unexpanded{\def\jlreq@resulta{#2}\def\jlreq@resultb{#3}}}}%
  }%
}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@switchpapersize}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@addpapersize}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@addpapersize@}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@addpapersize@@}

\jlreq@trimmarks@addpapersize{a0,A0}[a0]
\jlreq@trimmarks@addpapersize{a1,A1}[a1]
\jlreq@trimmarks@addpapersize{a2,A2}[a2]
\jlreq@trimmarks@addpapersize{a3,A3}[a3]
\jlreq@trimmarks@addpapersize{a4,A4}[a4]
\jlreq@trimmarks@addpapersize{a5,A5}[a5]
\jlreq@trimmarks@addpapersize{a6,A6}[a6]
\jlreq@trimmarks@addpapersize{a7,A7}[a7]
\jlreq@trimmarks@addpapersize{a8,A8}[a8]
\jlreq@trimmarks@addpapersize{a9,A9}[a9]
\jlreq@trimmarks@addpapersize{a10,A10}[a10]

\jlreq@trimmarks@addpapersize{b0,B0}[b0]
\jlreq@trimmarks@addpapersize{b1,B1}[b1]
\jlreq@trimmarks@addpapersize{b2,B2}[b2]
\jlreq@trimmarks@addpapersize{b3,B3}[b3]
\jlreq@trimmarks@addpapersize{b4,B4}[b4]
\jlreq@trimmarks@addpapersize{b5,B5}[b5]
\jlreq@trimmarks@addpapersize{b6,B6}[b6]
\jlreq@trimmarks@addpapersize{b7,B7}[b7]
\jlreq@trimmarks@addpapersize{b8,B8}[b8]
\jlreq@trimmarks@addpapersize{b9,B9}[b9]
\jlreq@trimmarks@addpapersize{b10,B10}[b10]

\jlreq@trimmarks@addpapersize{c2,C2}[c2]
\jlreq@trimmarks@addpapersize{c3,C3}[c3]
\jlreq@trimmarks@addpapersize{c4,C4}[c4]
\jlreq@trimmarks@addpapersize{c5,C5}[c5]
\jlreq@trimmarks@addpapersize{c6,C6}[c6]
\jlreq@trimmarks@addpapersize{c7,C7}[c7]
\jlreq@trimmarks@addpapersize{c8,C8}[c8]

\jlreq@trimmarks@addpapersize{a4var}[a4var]
\jlreq@trimmarks@addpapersize{b5var}[b5var]

\jlreq@trimmarks@addpapersize{letter}[letter]
\jlreq@trimmarks@addpapersize{legal}[legal]
\jlreq@trimmarks@addpapersize{executive}[executive]
\jlreq@trimmarks@addpapersize{hagaki}[hagaki]

% width -> \jlreq@resulta, height -> \jlreq@resultb
\edef\jlreq@trimmarks@analyzepapersize#1{%
  \noexpand\jlreq@switch{#1}{%
    \expandonce{\jlreq@trimmarks@switchpapersize}%
    {%
      \noexpand\jlreq@helper@dividebycomma{#1}
      \unexpanded{\ifjlreq@result\else}
        \unexpanded{\def\jlreq@resulta}{#1}
        \unexpanded{\def\jlreq@resultb}{#1}
      \noexpand\fi
    }%
  }\noexpand\relax%
}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@analyzepapersize}

\def\jlreq@trimmarks@option@papersize{+2in}
\DeclareOptionX{trimmarks_paper}{\def\jlreq@trimmarks@option@papersize{#1}}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@option@papersize}

\newif\ifjlreq@trimmarks@digital \jlreq@trimmarks@digitaltrue
\newif\ifjlreq@trimmarks@show \jlreq@trimmarks@showtrue
\newif\ifjlreq@trimmarks@show@artbox \jlreq@trimmarks@show@artboxfalse
\tombowdatetrue
% flag: `show` is specified or not
\newif\ifjlreq@trimmarks@option@show \jlreq@trimmarks@option@showfalse

\DeclareOptionX{show}{%
  \jlreq@trimmarks@showtrue
  \jlreq@ifempty{#1}{
    \jlreq@trimmarks@showtrue\tombowdatetrue\jlreq@trimmarks@digitaltrue
  }{
    \jlreq@trimmarks@showfalse\tombowdatefalse\jlreq@trimmarks@digitalfalse
    \@for\jlreq@trimmarks@tempa:=#1\do{%
      \expandafter\jlreq@helper@trim\expandafter{\jlreq@trimmarks@tempa}{\jlreq@trimmarks@tempa}
      \jlreq@switch{\jlreq@trimmarks@tempa}{
        {trimmarks}{\jlreq@trimmarks@showtrue}
        {banner}{\tombowdatetrue}
        {digital}{\jlreq@trimmarks@digitaltrue}
        {digital*}{\jlreq@trimmarks@digitaltrue\jlreq@trimmarks@show@artboxtrue}
        {no}{\tombowdatefalse\jlreq@trimmarks@showfalse\jlreq@trimmarks@digitalfalse}
      }[\PackageError{jlreq-trimmarks}{Unknown value `##1' in the option `show'}{\@ehc}]
    }
  }
}
\def\jlreq@trimmarks@bleed{3mm}
\DeclareOptionX{bleed_margin}{\def\jlreq@trimmarks@bleed{#1}}


\newif\ifjlreq@trimmarks@landscape \jlreq@trimmarks@landscapefalse
\jlreq@trimmarks@DeclareOption{landscape}{\jlreq@trimmarks@landscapetrue}
\jlreq@trimmarks@afterpkg@addtodeleteif{\ifjlreq@trimmarks@landscape}

\let\jlreq@temporary@original@@removeelement=\@removeelement
\let\@removeelement=\jlreq@helper@removeelement
\ProcessOptionsX*\relax
\let\@removeelement=\jlreq@temporary@original@@removeelement
\let\jlreq@temporary@original@@removeelement=\@undefined

\ifjlreq@trimmarks@option@show\else
  \ifx o\jlreq@trimmarks@driver
    \jlreq@trimmarks@digitalfalse
    \jlreq@trimmarks@showtrue
    \jlreq@trimmarks@show@artboxfalse
  \fi
\fi

\def\jlreq@trimmarks@setpapersize#1{
  \jlreq@ifcontains{#1}{+}{
    \def\@tempa##1+##2\jlreq@endmark{
      \jlreq@helper@trim{##1}{\jlreq@trimmarks@tempa}
      \jlreq@helper@trim{##2}{\jlreq@trimmarks@tempb}
      \ifx\jlreq@trimmarks@tempa\@empty
        \let\jlreq@tempa=\paperwidth
        \let\jlreq@tempb=\paperheight
      \else
        \expandafter\jlreq@trimmarks@analyzepapersize\expandafter{\jlreq@trimmarks@tempa}
        \let\jlreq@tempa=\jlreq@resulta
        \let\jlreq@tempb=\jlreq@resultb
        \ifjlreq@trimmarks@landscape\jlreq@helper@swap{\jlreq@tempa}{\jlreq@tempb}\fi
      \fi
      \expandafter\jlreq@trimmarks@analyzepapersize\expandafter{\jlreq@trimmarks@tempb}
      \ifjlreq@trimmarks@landscape\jlreq@helper@swap{\jlreq@resulta}{\jlreq@resultb}\fi
      \edef\jlreq@trimmarks@paperwidth{\the\dimexpr\jlreq@tempa + \jlreq@resulta\relax}
      \edef\jlreq@trimmarks@paperheight{\the\dimexpr\jlreq@tempb + \jlreq@resultb\relax}
    }
    \@tempa#1\jlreq@endmark
  }{
    \jlreq@trimmarks@analyzepapersize{#1}
    \ifjlreq@trimmarks@landscape\jlreq@helper@swap{\jlreq@resulta}{\jlreq@resultb}\fi
    \edef\jlreq@trimmarks@paperwidth{\jlreq@resulta}
    \edef\jlreq@trimmarks@paperheight{\jlreq@resultb}
  }
}
\jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@setpapersize}
\expandafter\jlreq@trimmarks@setpapersize\expandafter{\jlreq@trimmarks@option@papersize}

\ifx o\jlreq@trimmarks@driver
  \ifjlreq@trimmarks@digital
    \PackageError{jlreq-trimmarks}{`show=digital' can't be used with the driver `dviout'}{\@ehc}
  \fi
\fi

\def\jlreq@trimmarks@setbanner#1#2{%
  \jlreq@resultfalse
  \jlreq@parsekeyval[banner]{
    {top-left}{\jlreq@resulttrue\jlreq@trimmarks@setbanner@{#1@top@left}{##1}}
    {left-top}{\jlreq@resulttrue\jlreq@trimmarks@setbanner@{#1@top@left}{##1}}
    {top-right}{\jlreq@trimmarks@setbanner@{#1@top@right}{##1}}
    {right-top}{\jlreq@trimmarks@setbanner@{#1@top@right}{##1}}
    {bottom-left}{\jlreq@trimmarks@setbanner@{#1@bottom@left}{##1}}
    {left-bottom}{\jlreq@trimmarks@setbanner@{#1@bottom@left}{##1}}
    {bottom-right}{\jlreq@trimmarks@setbanner@{#1@bottom@right}{##1}}
    {right-bottom}{\jlreq@trimmarks@setbanner@{#1@bottom@right}{##1}}
  }{#2}
}

\def\jlreq@trimmarks@setbanner@#1#2{%
  \jlreq@parsekeyval@nokey{
    \jlreq@ifempty{##2}{
      \@namedef{jlreq@trimmarks@banner@odd@#1}{##1}
      \@namedef{jlreq@trimmarks@banner@even@#1}{##1}
    }{
      \jlreq@switch{##1}{
        {odd}{\@namedef{jlreq@trimmarks@banner@odd@#1}{##2}}
        {even}{\@namedef{jlreq@trimmarks@banner@even@#1}{##2}}
        {\PackageError{jlreq-trimmarks}{Undefined key `##1' in banner}{\@ehc}}
      }
    }
  }{#2}
}

\newcommand{\jlreqtrimmarkssetup}[1]{%
  \jlreq@parsekeyval{%
    {banner}{
      \@for\@tempa:=odd,even\do{
        \@for\jlreq@tempa:=tate,yoko\do{
          \@for\jlreq@tempb:=top,bottom\do{
            \@for\jlreq@tempc:=left,right\do{
              \@namedef{jlreq@trimmarks@banner@\@tempa @\jlreq@tempa @\jlreq@tempb @\jlreq@tempc}{}
            }
          }
        }
      }
      \@bannertoken{}%
      \jlreq@parsekeyval@nokey{
        \jlreq@ifempty{####2}{
          \@bannertoken{####1}
        }{
          \ifthenelse{\equal{####1}{tate} \OR \equal{####1}{yoko}}{
            \jlreq@trimmarks@setbanner{####1}{####2}
          }{
            \jlreq@trimmarks@setbanner{yoko}{####1={####2}}
          }
          \ifthenelse{\(\NOT \equal{####1}{tate}\) \AND \boolean{jlreq@result}}{
            \expandafter\@bannertoken\expandafter{\jlreq@trimmarks@banner@odd@yoko@top@left}
          }{}
        }
      }{##1}
    }
    {trimmarks_width}{\setlength{\@tombowwidth}{##1}}
    {color}{
      \jlreq@ifempty{##1}{
        \def\jlreq@trimmarks@color{\normalcolor}
      }{
        \@ifundefined{color}{
          \PackageError{jlreq-trimmarks}{`\string\color' is not defined, please load the package `color' or its variant before this package}{\@ehc}
        }
        \jlreq@switch{##1}{
          {c}{\def\jlreq@trimmarks@color{\color[cmyk]{1,0,0,0}}}
          {m}{\def\jlreq@trimmarks@color{\color[cmyk]{0,1,0,0}}}
          {y}{\def\jlreq@trimmarks@color{\color[cmyk]{0,0,1,0}}}
          {k}{\def\jlreq@trimmarks@color{\color[cmyk]{0,0,0,1}}}
          {cm}{\def\jlreq@trimmarks@color{\color[cmyk]{1,1,0,0}}}
          {cy}{\def\jlreq@trimmarks@color{\color[cmyk]{1,0,1,0}}}
          {ck}{\def\jlreq@trimmarks@color{\color[cmyk]{1,0,0,1}}}
          {my}{\def\jlreq@trimmarks@color{\color[cmyk]{0,1,1,0}}}
          {mk}{\def\jlreq@trimmarks@color{\color[cmyk]{0,1,0,1}}}
          {yk}{\def\jlreq@trimmarks@color{\color[cmyk]{0,0,1,1}}}
          {cmy}{\def\jlreq@trimmarks@color{\color[cmyk]{1,1,1,0}}}
          {cmk}{\def\jlreq@trimmarks@color{\color[cmyk]{1,1,0,1}}}
          {cyk}{\def\jlreq@trimmarks@color{\color[cmyk]{1,0,1,1}}}
          {myk}{\def\jlreq@trimmarks@color{\color[cmyk]{0,1,1,1}}}
          {cmyk}{\def\jlreq@trimmarks@color{\color[cmyk]{1,1,1,1}}}
          {
            \jlreq@iffirsttoken{##1}{[}{
              \def\@tempa[####1]####2\jlreq@endmark{\def\jlreq@trimmarks@color{\color[####1]{####2}}}
            }{
              \def\@tempa####1\jlreq@endmark{\def\jlreq@trimmarks@color{\color{####1}}}
            }
            \@tempa##1\jlreq@endmark
          }
        }
      }
    }
  }{#1}
}
\@onlypreamble\jlreqtrimmarkssetup
\jlreqtrimmarkssetup{
  banner={%
    \jobname\space(\number\year-\two@digits\month-\two@digits\day
    \space\two@digits\hour:\two@digits\minute)%
  },
  color={}
}

\ifx\jlreq@trimmarks@engine\@undefined
  \jlreq@helper@guessengine
  \let\jlreq@trimmarks@engine=\jlreq@result
\fi

\ifx\jlreq@trimmarks@driver\@undefined
  \ifx l\jlreq@trimmarks@engine
    \let\jlreq@trimmarks@driver=l
  \else
    % default: dvipdfmx
    \let\jlreq@trimmarks@driver=f
  \fi
\fi

\ifx l\jlreq@trimmarks@engine
  \setlength{\pagewidth}{\dimexpr\jlreq@trimmarks@paperwidth\relax}
  \setlength{\pageheight}{\dimexpr\jlreq@trimmarks@paperheight\relax}
\else
  \setlength{\pdfpagewidth}{\dimexpr\jlreq@trimmarks@paperwidth\relax}
  \setlength{\pdfpageheight}{\dimexpr\jlreq@trimmarks@paperheight\relax}
\fi

\hoffset=\dimexpr(\jlreq@trimmarks@paperwidth - \paperwidth)/2 - \ifx l\jlreq@trimmarks@engine 1in\else 1truein\fi\relax
\voffset=\dimexpr(\jlreq@trimmarks@paperheight - \paperheight)/2 - \ifx l\jlreq@trimmarks@engine 1in\else 1truein\fi\relax
\ifx l\jlreq@trimmarks@engine\else
  \@ifundefined{@tombowreset@@paper}{
    \AtBeginDocument{%
      \addtolength{\oddsidemargin}{\dimexpr 1truein - 1in\relax}%
      \addtolength{\evensidemargin}{\dimexpr 1truein - 1in\relax}%
      \addtolength{\topmargin}{\dimexpr 1truein - 1in\relax}%
    }
  }{
    \def\@tombowreset@@paper{%
       \@@topmargin\topmargin
       \iftombow
         \@@paperwidth\paperwidth
         \advance\@@paperwidth 2\dimexpr\@tombowbleed\relax
         \@@paperheight\paperheight \advance\@@paperheight 10mm\relax
         \advance\@@paperheight 2\dimexpr\@tombowbleed\relax
         % 1in -> 1truein
         \advance\@@topmargin 1truein\relax \advance\@themargin 1truein\relax
       \fi
    }
  }
\fi

\ifx l\jlreq@trimmarks@driver\else
  \jlreq@helper@divide{\the\mag pt}{1000pt}
  \edef\@tempa{\noexpand\AtBeginDvi{\noexpand\special{papersize=\the\dimexpr\strip@pt\jlreq@resultdimen\dimexpr\jlreq@trimmarks@paperwidth\relax\relax, \the\dimexpr\strip@pt\jlreq@resultdimen\dimexpr\jlreq@trimmarks@paperheight\relax\relax}}}
  \@tempa
\fi
\@ifundefined{stockheight}{\newlength{\stockheight}}{}
\@ifundefined{stockwidth}{\newlength{\stockwidth}}{}
\setlength{\stockwidth}{\dimexpr\jlreq@trimmarks@paperwidth\relax}
\setlength{\stockheight}{\dimexpr\jlreq@trimmarks@paperheight\relax}

\def\@outputtombow{%
  % 6mm = \@tombowbleed: from plcore
  \@@paperwidth=\dimexpr\@@paperwidth - 6mm + 2\dimexpr\jlreq@trimmarks@bleed\relax\relax
  \@@paperheight=\dimexpr\@@paperheight - 6mm + 2\dimexpr\jlreq@trimmarks@bleed\relax\relax
  \ifjlreq@trimmarks@show\expandafter\@firstofone\else\expandafter\@gobble\fi{%
    \vbox to\z@{%
      \kern-\dimexpr 10mm + \jlreq@trimmarks@bleed\relax
      \boxmaxdepth\maxdimen
      \moveleft\jlreq@trimmarks@bleed\vbox to\@@paperheight{%
        \color@begingroup\jlreq@trimmarks@color
        \hbox to\@@paperwidth{%
          \hskip\jlreq@trimmarks@bleed\relax
          \hbox to\z@{% \@TL
            \yoko\hss
            \vrule width\dimexpr 10mm + \jlreq@trimmarks@bleed\relax height\@tombowwidth depth\z@
            \vrule height10mm width\@tombowwidth depth\z@
            \iftombowdate
              \raise4pt\hbox to\z@{\hskip5mm\@bannerfont
              \ifodd\c@page\the\@bannertoken\else\jlreq@trimmarks@banner@even@yoko@top@left\fi
              \hss}%
            \fi
          }%
          \hfill
          \hbox{% \@TC
            \yoko
            \vrule width10mm height\@tombowwidth depth\z@
            \vrule height10mm width\@tombowwidth depth\z@
            \vrule width10mm height\@tombowwidth depth\z@
          }%
          \hfill
          \hbox to\z@{% \@TR
            \yoko
            \iftombowdate
              \expandafter\let\expandafter\jlreq@tempa\csname jlreq@trimmarks@banner@\ifodd\c@page odd\else even\fi @yoko@top@right\endcsname
              \ifx\jlreq@tempa\@empty\else
                \raise4pt\hbox to 0pt{\yoko\hss\@bannerfont\jlreq@tempa\hskip 5mm}%
              \fi
            \fi
            \vrule height10mm width\@tombowwidth depth\z@
            \vrule width\dimexpr 10mm + \jlreq@trimmarks@bleed\relax height\@tombowwidth depth\z@\hss
          }%
          \hskip\jlreq@trimmarks@bleed
        }%
        \kern-10mm
        \hbox to\@@paperwidth{%
          \hbox to\z@{% \@Tl
            \yoko\hss
            \vrule width10mm height\@tombowwidth depth\z@
            \vrule height\dimexpr 10mm + \jlreq@trimmarks@bleed\relax width\@tombowwidth depth\z@
            \iftombowdate
              \expandafter\let\expandafter\jlreq@tempa\csname jlreq@trimmarks@banner@\ifodd\c@page odd\else even\fi @tate@top@left\endcsname
              \ifx\jlreq@tempa\@empty\else
                \setbox\jlreq@tempboxa=\hbox{\tate\adjustbaseline\hss\@bannerfont\jlreq@tempa}%
                \ifx l\jlreq@trimmarks@engine
                  \jlreq@tempdima=\ht\jlreq@tempboxa
                \else
                  \jlreq@tempdima=\dimexpr\wd\jlreq@tempboxa\relax
                \fi
                \ht\jlreq@tempboxa=0pt \dp\jlreq@tempboxa=0pt \wd\jlreq@tempboxa=0pt
                \kern-\dimexpr\jlreq@tempdima + 4pt\relax
                \raise -5mm\box\jlreq@tempboxa
                \kern\dimexpr\jlreq@tempdima + 4pt\relax
              \fi
            \fi
          }%
          \hfill
          \hbox to\z@{% \@Tr
            \yoko
            \iftombowdate
              \expandafter\let\expandafter\jlreq@tempa\csname jlreq@trimmarks@banner@\ifodd\c@page odd\else even\fi @tate@top@right\endcsname
              \ifx\jlreq@tempa\@empty\else
                \setbox\jlreq@tempboxa=\hbox{\tate\adjustbaseline\hss\@bannerfont\jlreq@tempa}%
                \ht\jlreq@tempboxa=0pt \dp\jlreq@tempboxa=0pt \wd\jlreq@tempboxa=0pt
                \kern 4pt
                \raise -5mm\box\jlreq@tempboxa
                \kern -4pt
              \fi
            \fi
            \vrule height\dimexpr 10mm + \jlreq@trimmarks@bleed\relax width\@tombowwidth depth\z@
            \vrule width10mm height\@tombowwidth depth\z@\hss
          }%
        }%
        \vfill
        \hbox to\@@paperwidth{%
          \hbox to\z@{% \@CL
            \yoko\hss
            \vrule width10mm height.5\@tombowwidth depth.5\@tombowwidth
            \vrule height10mm depth10mm width\@tombowwidth
          }%
          \hfill
          \hbox to\z@{% \@CR
            \yoko
            \vrule height10mm depth10mm width\@tombowwidth
            \vrule height.5\@tombowwidth depth.5\@tombowwidth width10mm\hss
          }%
        }%
        \vfill
        \hbox to\@@paperwidth{%
          \hbox to\z@{% \@Bl
            \yoko\hss
            \vrule width10mm depth\@tombowwidth height\z@
            \vrule depth\dimexpr 10mm + \jlreq@trimmarks@bleed\relax width\@tombowwidth height\z@
            \iftombowdate
              \expandafter\let\expandafter\jlreq@tempa\csname jlreq@trimmarks@banner@\ifodd\c@page odd\else even\fi @tate@bottom@left\endcsname
              \ifx\jlreq@tempa\@empty\else
                \setbox\jlreq@tempboxa=\hbox{\tate\adjustbaseline\@bannerfont\jlreq@tempa\hss}%
                \ifx l\jlreq@trimmarks@engine
                  \jlreq@tempdima=\dimexpr\wd\jlreq@tempboxa\relax
                  \jlreq@tempdimb=\dimexpr\wd\jlreq@tempboxa\relax
                \else
                  \jlreq@tempdima=\dimexpr\wd\jlreq@tempboxa\relax
                  \jlreq@tempdimb=\dimexpr\ht\jlreq@tempboxa + \dp\jlreq@tempboxa\relax
                \fi
                \ht\jlreq@tempboxa=0pt \dp\jlreq@tempboxa=0pt \wd\jlreq@tempboxa=0pt
                \kern-\dimexpr\jlreq@tempdima + 4pt\relax
                \raise\dimexpr\jlreq@tempdimb + 5mm\relax\box\jlreq@tempboxa
                \kern\dimexpr\jlreq@tempdima + 4pt\relax
              \fi
            \fi
          }%
          \hfill
          \hbox to\z@{% \@Br
            \yoko
            \iftombowdate
              \expandafter\let\expandafter\jlreq@tempa\csname jlreq@trimmarks@banner@\ifodd\c@page odd\else even\fi @tate@bottom@right\endcsname
              \ifx\jlreq@tempa\@empty\else
                \setbox\jlreq@tempboxa=\hbox{\tate\adjustbaseline\hss\@bannerfont\jlreq@tempa}%
                \ifx l\jlreq@trimmarks@engine
                  \jlreq@tempdima=\wd\jlreq@tempboxa
                \else
                  \jlreq@tempdima=\dimexpr\ht\jlreq@tempboxa + \dp\jlreq@tempboxa\relax
                \fi
                \ht\jlreq@tempboxa=0pt \dp\jlreq@tempboxa=0pt \wd\jlreq@tempboxa=0pt
                \kern 4pt
                \raise\dimexpr\jlreq@tempdima + 5mm\relax\box\jlreq@tempboxa
                \kern -4pt
              \fi
            \fi
            \vrule depth\dimexpr 10mm + \jlreq@trimmarks@bleed\relax width\@tombowwidth height\z@
            \vrule width10mm depth\@tombowwidth height\z@\hss
          }%
        }%
        \kern-10mm
        \hbox to\@@paperwidth{%
          \hskip\jlreq@trimmarks@bleed\relax
          \hbox to\z@{% \@BL
            \yoko\hss
            \vrule width\dimexpr 10mm + \jlreq@trimmarks@bleed\relax depth\@tombowwidth height\z@
            \vrule depth10mm width\@tombowwidth height\z@
            \iftombowdate
              \expandafter\let\expandafter\jlreq@tempa\csname jlreq@trimmarks@banner@\ifodd\c@page odd\else even\fi @yoko@bottom@left\endcsname
              \ifx\jlreq@tempa\@empty\else
                \setbox\jlreq@tempboxa=\hbox to 0pt{\yoko\hskip 5mm\@bannerfont\jlreq@tempa\hss}%
                \jlreq@tempdima=\dimexpr\ht\jlreq@tempboxa + \dp\jlreq@tempboxa\relax
                \ht\jlreq@tempboxa=0pt \dp\jlreq@tempboxa=0pt
                \raise-\dimexpr\jlreq@tempdima + 4pt\relax\box\jlreq@tempboxa
              \fi
            \fi
          }%
          \hfill
          \hbox{% \@BC
            \yoko
            \vrule width10mm depth\@tombowwidth height\z@
            \vrule depth10mm width\@tombowwidth height\z@
            \vrule width10mm depth\@tombowwidth height\z@
          }%
          \hfill
          \hbox to\z@{% \@BR
            \yoko
            \iftombowdate
              \expandafter\let\expandafter\jlreq@tempa\csname jlreq@trimmarks@banner@\ifodd\c@page odd\else even\fi @yoko@bottom@right\endcsname
              \ifx\jlreq@tempa\@empty\else
              \setbox\jlreq@tempboxa=\hbox to 0pt{\yoko\hss\@bannerfont\jlreq@tempa\hskip 5mm}%
                \jlreq@tempdima=\dimexpr\ht\jlreq@tempboxa + \dp\jlreq@tempboxa\relax
                \ht\jlreq@tempboxa=0pt \dp\jlreq@tempboxa=0pt
                \raise-\dimexpr\jlreq@tempdima + 4pt\relax\box\jlreq@tempboxa
              \fi
            \fi
            \vrule depth10mm width\@tombowwidth height\z@
            \vrule width\dimexpr 10mm + \jlreq@trimmarks@bleed\relax depth\@tombowwidth height\z@\hss
          }%
          \hskip\jlreq@trimmarks@bleed
        }%
      \color@endgroup}\vss
    }%
  }%
}

\ifjlreq@trimmarks@digital
  \ifx l\jlreq@trimmarks@engine
    \setlength\jlreq@resultdimen{1pt}
  \else
    \jlreq@helper@divide{\the\mag pt}{1000pt}
  \fi
  % 0.9963 = 1pt/1bp (almost)
  \edef\jlreq@trimmarks@pttobp#1{\noexpand\strip@pt\noexpand\dimexpr\strip@pt\jlreq@resultdimen\noexpand\dimexpr0.9963\noexpand\dimexpr#1\unexpanded{\relax\relax\relax}}
  \edef\jlreq@trimmarks@trimboxsize{%
    [%
      \jlreq@trimmarks@pttobp{(\jlreq@trimmarks@paperwidth - \paperwidth)/2}
      \jlreq@trimmarks@pttobp{(\jlreq@trimmarks@paperheight - \paperheight)/2}
      \jlreq@trimmarks@pttobp{(\jlreq@trimmarks@paperwidth + \paperwidth)/2}
      \jlreq@trimmarks@pttobp{(\jlreq@trimmarks@paperheight + \paperheight)/2}%
    ]
  }
  \edef\jlreq@trimmarks@bleedboxsize{%
    [%
      \jlreq@trimmarks@pttobp{(\jlreq@trimmarks@paperwidth - \paperwidth)/2 - \jlreq@trimmarks@bleed}
      \jlreq@trimmarks@pttobp{(\jlreq@trimmarks@paperheight - \paperheight)/2 - \jlreq@trimmarks@bleed}
      \jlreq@trimmarks@pttobp{(\jlreq@trimmarks@paperwidth + \paperwidth)/2 + \jlreq@trimmarks@bleed}
      \jlreq@trimmarks@pttobp{(\jlreq@trimmarks@paperheight + \paperheight)/2 + \jlreq@trimmarks@bleed}%
    ]
  }
  \edef\jlreq@trimmarks@pdfattribute{%
    /TrimBox \jlreq@trimmarks@trimboxsize
    \ifjlreq@trimmarks@show@artbox /ArtBox \jlreq@trimmarks@trimboxsize\fi
    /BleedBox \jlreq@trimmarks@bleedboxsize
  }
  \jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@pttobp}
  \jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@trimboxsize}
  \jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@bleedboxsize}
  \jlreq@trimmarks@afterpkg@addtodeletecs{\jlreq@trimmarks@pdfattribute}

  \ifx l\jlreq@trimmarks@driver
    \edef\@tempa{\noexpand\pdfvariable pageattr{\jlreq@trimmarks@pdfattribute}}
    \@tempa
  \fi
  \ifx f\jlreq@trimmarks@driver
    \edef\@outputtombow{\noexpand\special{pdf: put @thispage <<\jlreq@trimmarks@pdfattribute>>}\expandonce{\@outputtombow}}
  \fi
  \ifx s\jlreq@trimmarks@driver
    \edef\@tempa{\noexpand\special{ps:SDict begin
      [ /TrimBox \jlreq@trimmarks@trimboxsize /PAGE pdfmark
      \ifjlreq@trimmarks@show@artbox [ /ArtBox   \jlreq@trimmarks@trimboxsize /PAGE pdfmark \fi
      [ /BleedBox \jlreq@trimmarks@bleedboxsize /PAGE pdfmark
    end}}%
    \@tempa
  \fi
\fi

% always true
\tombowtrue


\endinput
